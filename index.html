// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// --- Config and Initialization ---
const firebaseConfig = {
  apiKey: "AIzaSyBqvd38A2xTbvmvuJWVBXhc83NcVuH4LaM",
  authDomain: "metal-stock-faf6c.firebaseapp.com",
  projectId: "metal-stock-faf6c",
  storageBucket: "metal-stock-faf6c.appspot.com",
  messagingSenderId: "531401442922",
  appId: "1:531401442922:web:0d8159091329069ec2ac13"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
setLogLevel('debug');

// --- State Variables ---
let userId = null;
let inventoryCollectionRef = null;
let fullInventory = [];
const LOW_STOCK_THRESHOLD = 10;
let isLoginMode = true;

// --- DOM Elements ---
const authContainer = document.getElementById('authContainer');
const appContainer = document.getElementById('appContainer');
const authForm = document.getElementById('authForm');
const authToggleLink = document.getElementById('authToggleLink');
const authTitle = document.getElementById('authTitle');
const authSubmitBtn = document.getElementById('authSubmitBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userEmail = document.getElementById('userEmail');
const forgotPasswordLink = document.getElementById('forgotPasswordLink'); // New element
const addItemForm = document.getElementById('addItemForm');
const inventoryTableBody = document.getElementById('inventoryTableBody');
const searchInput = document.getElementById('searchInput');
const transactionModal = document.getElementById('transactionModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const transactionForm = document.getElementById('transactionForm');
const modalItemId = document.getElementById('modalItemId');
const modalItemInfo = document.getElementById('modalItemInfo');
const messageBox = document.getElementById('messageBox');
const messageText = document.getElementById('messageText');
const loadingOverlay = document.getElementById('loadingOverlay');

// --- Authentication Logic ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        userId = user.uid;
        userEmail.textContent = user.email;
        inventoryCollectionRef = collection(db, `users/${userId}/inventory`); // The fix from before
        authContainer.classList.add('hidden-by-auth');
        appContainer.classList.remove('hidden-by-auth');
        listenForInventoryUpdates();
    } else {
        userId = null;
        inventoryCollectionRef = null;
        fullInventory = [];
        renderInventory([]); // Make sure you have this function
        authContainer.classList.remove('hidden-by-auth');
        appContainer.classList.add('hidden-by-auth');
    }
});

authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = authForm.email.value;
    const password = authForm.password.value;
    loadingOverlay.style.display = 'flex';
    try {
        if (isLoginMode) {
            await signInWithEmailAndPassword(auth, email, password);
        } else {
            await createUserWithEmailAndPassword(auth, email, password);
        }
    } catch (error) {
        showMessage(error.message, true);
    } finally {
        loadingOverlay.style.display = 'none';
    }
});

signOutBtn.addEventListener('click', async () => {
    await signOut(auth);
});

authToggleLink.addEventListener('click', (e) => {
    e.preventDefault();
    isLoginMode = !isLoginMode;
    const forgotPasswordContainer = document.getElementById('forgotPasswordLink').parentElement.parentElement;
    if (isLoginMode) {
        authTitle.textContent = 'Sign in to your account';
        authSubmitBtn.textContent = 'Sign In';
        authToggleLink.innerHTML = 'Don\'t have an account? <span class="font-bold">Sign Up</span>';
        forgotPasswordContainer.style.display = 'flex'; // Show forgot password link
    } else {
        authTitle.textContent = 'Create a new account';
        authSubmitBtn.textContent = 'Sign Up';
        authToggleLink.innerHTML = 'Already have an account? <span class="font-bold">Sign In</span>';
        forgotPasswordContainer.style.display = 'none'; // Hide forgot password link
    }
});

// --- NEW: FORGOT PASSWORD LOGIC ---
forgotPasswordLink.addEventListener('click', async (e) => {
    e.preventDefault();
    const email = authForm.email.value;
    if (!email) {
        showMessage("Please enter your email address in the email field first.", true);
        return;
    }
    loadingOverlay.style.display = 'flex';
    try {
        await sendPasswordResetEmail(auth, email);
        showMessage(`Password reset link sent to ${email}. Please check your inbox.`);
    } catch (error) {
        showMessage(error.message, true);
    } finally {
        loadingOverlay.style.display = 'none';
    }
});


// --- Utility, Firestore, Rendering, and Event Listeners ---
// Make sure all your other functions like renderInventory, filterAndRender, etc. are below this line.
// The code you sent before was cut off, so I am including placeholders.

function showMessage(message, isError = false) {
    messageText.textContent = message;
    messageBox.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transition-transform transform ${isError ? 'bg-red-500' : 'bg-green-500'}`;
    messageBox.classList.remove('hidden', 'translate-x-full');
    setTimeout(() => {
        messageBox.classList.add('translate-x-full');
        setTimeout(() => messageBox.classList.add('hidden'), 300);
    }, 4000); // Increased time to read message
}

function listenForInventoryUpdates() {
    if (!inventoryCollectionRef) return;
    onSnapshot(inventoryCollectionRef, (snapshot) => {
        fullInventory = [];
        snapshot.forEach(doc => fullInventory.push({ id: doc.id, ...doc.data() }));
        filterAndRender(); // Call your main render function
    }, (error) => {
        console.error("Error listening to inventory:", error);
        showMessage("Could not fetch real-time inventory updates.", true);
    });
}

function filterAndRender() {
    const searchTerm = searchInput.value.toLowerCase();
    const filtered = fullInventory.filter(item => {
        return (item.material?.toLowerCase().includes(searchTerm) ||
                item.shape?.toLowerCase().includes(searchTerm) ||
                item.dimensions?.toLowerCase().includes(searchTerm));
    });
    renderInventory(filtered);
}

function renderInventory(items) {
    inventoryTableBody.innerHTML = ''; // Clear existing rows
    if (!items || items.length === 0) {
        inventoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-500">No items in inventory.</td></tr>';
        return;
    }
    items.forEach(item => {
        const row = document.createElement('tr');
        row.className = item.currentStock < LOW_STOCK_THRESHOLD ? 'bg-red-100' : 'bg-white';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.material}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.shape}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.dimensions}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${item.currentStock < LOW_STOCK_THRESHOLD ? 'text-red-600' : 'text-gray-800'}">${item.currentStock}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                <button class="text-indigo-600 hover:text-indigo-900 manage-stock-btn" data-id="${item.id}">Manage</button>
                <button class="text-red-600 hover:text-red-900 ml-4 delete-item-btn" data-id="${item.id}">Delete</button>
            </td>
        `;
        inventoryTableBody.appendChild(row);
    });
}

// --- Event Listeners for Forms and Buttons ---
searchInput.addEventListener('input', filterAndRender);

// (Add other event listeners for addItemForm, transactionForm, etc. here if they are missing)
// It seems your original code had more functions and event listeners that were not included in the paste.
// The provided code above will handle authentication and the forgot password feature.
